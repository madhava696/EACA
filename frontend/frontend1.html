<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion-Aware Coding Assistant</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

<style>
body {
  font-family: 'Inter', sans-serif;
  background-color: #0f172a;
  color: white;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: #475569; border-radius: 5px; }

.message { opacity: 0; transform: translateY(10px); animation: fadeIn 0.3s forwards; }
@keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

.input-bar {
  position: sticky;
  bottom: 0;
  background: #1e293b;
  padding: 10px;
  border-top: 1px solid #334155;
  z-index: 50;
}

.sidebar { transition: transform 0.3s ease; transform: translateX(0); }
.sidebar.hidden { transform: translateX(-100%); }

.modal-bg { background: rgba(0, 0, 0, 0.6); }
.modal { background: #1e293b; border-radius: 12px; padding: 20px; width: 300px; }
</style>
</head>
<body class="flex h-screen">

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar w-64 bg-[#1e293b] p-4 flex flex-col">
    <h2 class="text-xl font-semibold mb-4 text-center">Emotion Assistant</h2>
    <button id="newChatBtn" class="bg-blue-500 hover:bg-blue-600 py-2 px-4 rounded-lg mb-2">+ New Chat</button>
    <input id="searchChatInput" type="text" placeholder="Search chats..." class="p-2 rounded bg-[#0f172a] border border-gray-700 mb-3 text-sm" />
    <div id="chatHistory" class="flex-1 overflow-y-auto space-y-2 text-sm"></div>
    <button id="settingsBtn" class="mt-4 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Settings</button>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col relative">
    <!-- Header -->
    <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-[#1e293b] text-lg font-semibold sticky top-0 z-50">
      <button id="menuBtn" class="text-gray-300 hover:text-white">‚ò∞</button>
      <span>Emotion-Aware Coding Assistant</span>
      <span></span>
    </div>

    <!-- Chat Messages -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32 bg-[#0f172a]"></div>

    <!-- Input Bar -->
    <div class="input-bar flex items-center gap-3">
      <button id="micBtn" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-lg">üéôÔ∏è</button>
      <button id="cameraBtn" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-lg">üì∑</button>
      <input id="user-input" type="text" placeholder="Send a message..." class="flex-1 p-3 rounded-lg bg-[#0f172a] border border-gray-700 text-white focus:outline-none" />
      <button id="send-btn" class="bg-blue-500 hover:bg-blue-600 px-5 py-3 rounded-lg font-medium">Send</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
    <div class="modal text-center">
      <h3 class="text-lg font-semibold mb-3">‚öô Settings</h3>
      <button id="toggleTheme" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded mb-2">Toggle Theme</button>
      <button id="clearChats" class="w-full bg-red-600 hover:bg-red-500 py-2 rounded mb-2">Clear All Chats</button>
      <button id="closeSettings" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">Close</button>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menuBtn");
    const settingsModal = document.getElementById("settingsModal");
    const settingsBtn = document.getElementById("settingsBtn");
    const toggleThemeBtn = document.getElementById("toggleTheme");
    const clearChatsBtn = document.getElementById("clearChats");
    const closeSettings = document.getElementById("closeSettings");
    const chatContainer = document.getElementById("chat-container");
    const sendBtn = document.getElementById("send-btn");
    const userInput = document.getElementById("user-input");
    const chatHistory = document.getElementById("chatHistory");
    const newChatBtn = document.getElementById("newChatBtn");
    const searchChatInput = document.getElementById("searchChatInput");

    let currentChatId = null;
    let darkTheme = true;
    let chats = JSON.parse(localStorage.getItem("chats") || "[]");

    function saveChats() { localStorage.setItem("chats", JSON.stringify(chats)); }

    function createRobot() {
      const robot = document.createElement("div");
      robot.classList.add("w-10", "h-10", "rounded-full", "bg-gray-600", "flex", "items-center", "justify-center");
      const face = document.createElement("div");
      face.classList.add("text-white", "text-xs", "font-bold");
      face.textContent = "ü§ñ";
      robot.appendChild(face);
      return robot;
    }

    function addMessage(content, sender = "user") {
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("flex", "items-start", "gap-3", "message");
      msgDiv.classList.toggle("flex-row-reverse", sender === "user");

      const avatar = sender === "bot" ? createRobot() : document.createElement("div");
      if (sender === "user") {
        avatar.classList.add("w-10", "h-10", "rounded-full", "bg-blue-500", "flex", "items-center", "justify-center", "font-bold");
        avatar.textContent = "U";
      }

      const bubble = document.createElement("div");
      bubble.classList.add("max-w-[75%]", "p-3", "rounded-2xl", "text-sm", "whitespace-pre-wrap", "leading-relaxed");
      if (sender === "user") bubble.classList.add("bg-blue-600", "text-white", "rounded-br-none");
      else bubble.classList.add("bg-gray-700", "text-gray-100", "rounded-bl-none");
      bubble.textContent = content;

      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubble);
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      const chat = chats.find(c => c.id === currentChatId);
      if (chat) {
        chat.messages.push({ sender, content });
        if (chat.title.startsWith("Chat") && sender === "user" && chat.messages.length === 1) {
          chat.title = content.length > 25 ? content.slice(0, 25) + "..." : content;
        }
        saveChats();
        renderChatHistory();
      }
    }

    function renderChatHistory(filter = "") {
      chatHistory.innerHTML = "";
      const filtered = chats.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()));
      if (filtered.length === 0) {
        chatHistory.innerHTML = '<div class="text-gray-400 text-sm text-center mt-10">No chats found</div>';
        return;
      }
      filtered.forEach(chat => {
        const btn = document.createElement("button");
        btn.textContent = chat.title;
        btn.classList.add("w-full", "text-left", "p-2", "rounded-lg", "bg-gray-800", "hover:bg-gray-700");
        btn.onclick = () => loadChat(chat.id);
        chatHistory.appendChild(btn);
      });
    }

    function loadChat(id) {
      const chat = chats.find(c => c.id === id);
      if (!chat) return;
      currentChatId = id;
      chatContainer.innerHTML = "";
      chat.messages.forEach(m => addMessage(m.content, m.sender));
    }

    function startNewChat() {
      const id = Date.now();
      const title = `Chat ${chats.length + 1}`;
      const newChat = { id, title, messages: [] };
      chats.push(newChat);
      currentChatId = id;
      saveChats();
      renderChatHistory();
      chatContainer.innerHTML = "";
      addMessage("üëã Hello! How can I assist you today?", "bot");
    }

    // ‚úÖ Connect to FastAPI backend
    sendBtn.addEventListener("click", () => {
      const text = userInput.value.trim();
      if (!text) return;
      addMessage(text, "user");
      userInput.value = "";

      fetch("http://127.0.0.1:8000/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text }),
      })
        .then(res => res.json())
        .then(data => addMessage(data.response, "bot"))
        .catch(err => {
          console.error(err);
          addMessage("‚ö†Ô∏è Unable to connect to backend.", "bot");
        });
    });

    userInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendBtn.click();
    });

    newChatBtn.addEventListener("click", startNewChat);
    searchChatInput.addEventListener("input", e => renderChatHistory(e.target.value));
    menuBtn.addEventListener("click", () => sidebar.classList.toggle("hidden"));
    settingsBtn.addEventListener("click", () => settingsModal.classList.remove("hidden"));
    closeSettings.addEventListener("click", () => settingsModal.classList.add("hidden"));

    toggleThemeBtn.addEventListener("click", () => {
      darkTheme = !darkTheme;
      document.body.style.backgroundColor = darkTheme ? "#0f172a" : "#f8fafc";
      document.body.style.color = darkTheme ? "white" : "black";
      document.querySelectorAll(".input-bar, .sidebar, .modal").forEach(el => {
        el.style.backgroundColor = darkTheme ? "#1e293b" : "#e2e8f0";
      });
      settingsModal.classList.add("hidden");
    });

    clearChatsBtn.addEventListener("click", () => {
      if (confirm("Clear all chats?")) {
        chats = [];
        saveChats();
        renderChatHistory();
        chatContainer.innerHTML = "";
        startNewChat();
        settingsModal.classList.add("hidden");
      }
    });

    // Initialize
    if (chats.length === 0) startNewChat();
    else { renderChatHistory(); loadChat(chats[chats.length - 1].id); }
  </script>
</body>
</html>
